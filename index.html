<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>HUF System Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script src="devices.js"></script>
    <script src="config.js"></script>
    <style>
        :root { --huf-red: #e30613; --huf-dark: #333; --today-blue: #007bff; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; margin: 0; padding: 10px; }
        .card { max-width: 900px; margin: auto; background: #fff; padding: 12px; border-radius: 12px; border-top: 8px solid var(--huf-red); box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; min-height: 550px; transition: max-width 0.4s ease; }
        .card.wide-view { max-width: 98%; }
        .logo-container { text-align: center; margin-bottom: 10px; }
        .logo-container img { max-width: 200px; display: block; margin: 0 auto; }
        .logo-subtitle { margin: 0; padding: 0; font-size: 14px; font-weight: bold; color: #555; line-height: 1.2; }
        h2 { color: var(--huf-red); text-align: center; text-transform: uppercase; margin: 5px 0 2px 0; font-size: 1.4rem; }
        .view-layer { display: none; }
        .active-view { display: block; }
        .login-box { width: 350px; margin: 50px auto; text-align: center; }
        .input-login { width: 100%; padding: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #bbb; border-radius: 6px; font-size: 18px; box-sizing: border-box; }
        #loginError { color: var(--huf-red); font-weight: bold; font-size: 14px; margin-bottom: 10px; display: none; }
        .menu-container { display: flex; flex-direction: column; gap: 20px; padding: 40px 20px; max-width: 500px; margin: auto; }
        .btn-menu { background: #fff; border: 3px solid var(--huf-red); color: #333; padding: 25px; border-radius: 15px; font-size: 22px; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-menu:hover { background: var(--huf-red); color: white; transform: translateY(-3px); }
        .flex-layout { display: flex; gap: 1px; flex-wrap: wrap; }
        .column { flex: 1; min-width: 450px; }
        label.main-label { display: block; font-weight: bold; margin-bottom: 2px; font-size: 22px; text-align: left; }
        select, textarea, input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; background: #fff; }
        textarea { height: 40px; resize: none; }
        .stage-container { display: flex; gap: 8px; }
        .btn-stage { flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-weight: bold; color: #555; }
        .btn-stage.active { background: var(--huf-red); color: white; border-color: var(--huf-red); }
        .tasks-scroll { border: 10px solid #eee; background: #fafafa; border-radius: 6px; padding: 8px; column-count: 3; column-gap: 15px; display: block; min-height: 100px; }
        .task-row { display: flex; align-items: center; gap: 6px; font-size: 12px; border-bottom: 1px solid #eee; padding: 4px 5px; break-inside: avoid; border-radius: 4px; }
        .task-row.checked-task { background-color: #d4edda; color: #155724; }
        .signature-box { border: 2px dashed #bbb; border-radius: 6px; background: #fff; height: 100px; }
        #canvas { width: 100%; height: 100%; touch-action: none; }
        .tooling-input-bar { display: flex; gap: 8px; margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #ddd; align-items: flex-end; flex-wrap: wrap; }
        .tooling-input-bar div { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 110px; }
        .tooling-input-bar label { font-size: 10px; font-weight: bold; color: #666; }
        .gantt-wrapper { overflow: auto; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 600px; position: relative; scroll-behavior: smooth; }
        .gantt-grid { display: grid; grid-template-columns: 350px 1fr; min-width: fit-content; }
        .gantt-header-title { background: #222; color: white; padding: 10px; font-weight: bold; position: sticky; left: 0; top: 0; z-index: 100; border-right: 2px solid #555; display: flex; align-items: center; }
        .gantt-header-days { display: flex; background: var(--huf-dark); color: white; height: 100px; position: sticky; top: 0; z-index: 80; }
        .gantt-day-cell { flex: 1 0 70px; min-width: 70px; border-right: 1px solid #444; display: flex; align-items: center; justify-content: center; }
        .gantt-day-cell.is-today { background-color: var(--today-blue) !important; color: white; }
        .vertical-text { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; font-size: 12px; font-weight: bold; }
        .gantt-row { display: contents; }
        .gantt-task-name { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; background: #ffffff !important; border-right: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center; cursor: pointer; position: sticky; left: 0; z-index: 90; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .gantt-bar-container { position: relative; height: 65px; border-bottom: 1px solid #eee; background: #fff; z-index: 10; }
        .gantt-bar { position: absolute; border-radius: 6px; color: #333; font-size: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; font-weight: bold; padding: 0 5px; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); transition: opacity 0.2s; user-select: none; border: 1px solid rgba(0,0,0,0.05); z-index: 20; }
        .gantt-bar:hover { opacity: 0.8; }
        .btn-send { background: var(--huf-red); color: white; width: 100%; padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 18px; margin-top: 20px; }
        .btn-logout { position: absolute; top: 10px; right: 10px; background: #666; color: white; border: none; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .btn-back { position: absolute; top: 10px; left: 10px; background: #eee; color: #333; border: 1px solid #ccc; padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .collapse-controls { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        .btn-collapse { background: #444; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-center { background: var(--today-blue); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .btn-stats { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .stats-view-container { display: flex; flex-direction: column; gap: 15px; max-height: 70vh; overflow-y: auto; padding-right: 5px; }
        .device-stat-row { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        .device-stat-title { font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .stats-week-wrapper { display: flex; height: 80px; align-items: flex-end; gap: 2px; border-bottom: 1px solid #999; padding-bottom: 2px; overflow-x: auto; }
        .stats-week-col { flex: 1; min-width: 18px; display: flex; flex-direction: column; justify-content: flex-end; height: 100%; position: relative; }
        .bar-fill { width: 100%; border-top-left-radius: 2px; border-top-right-radius: 2px; transition: height 0.3s; position: relative; }
        .bar-fill:hover::after { content: attr(data-label); position: absolute; top: -18px; left: 50%; transform: translateX(-50%); background: #333; color: white; font-size: 9px; padding: 1px 4px; border-radius: 3px; z-index: 10; white-space: nowrap; }
        .week-label-stat { font-size: 8px; color: #777; margin-top: 2px; text-align: center; }
    </style>
</head>
<body onkeydown="manejarEnter(event)">

<div id="mainCard" class="card">
    <div class="logo-container">
        <img src="logo.png" alt="HUF Logo" onerror="this.style.display='none';">
        <p class="logo-subtitle">Developed By Omar Amador - HUF Mexico</p>
    </div>

    <div id="viewLogin" class="view-layer active-view">
        <div class="login-box">
            <h2>SYSTEM ACCESS</h2>
            <div id="loginError">‚ö†Ô∏è Invalid User or Password</div>
            <input type="text" id="userInput" class="input-login" placeholder="User" oninput="limpiarError()">
            <input type="password" id="passInput" class="input-login" placeholder="Password" oninput="limpiarError()">
            <button class="btn-send" onclick="validarAcceso()">ENTER</button>
        </div>
    </div>

    <div id="viewMenu" class="view-layer">
        <button class="btn-logout" onclick="logout()">LOGOUT</button>
        <h2 style="margin-top: 20px;">Main Selection</h2>
        <div class="menu-container">
            <button class="btn-menu" onclick="showModule('viewChecklist')">üìã Check List</button>
            <button class="btn-menu" onclick="showModule('viewTooling')">üõ† Tooling Projects</button>
            <button class="btn-menu" onclick="alert('Module under development')">‚öñ Report Calibration</button>
        </div>
    </div>

    <div id="viewChecklist" class="view-layer">
        <button class="btn-back" onclick="showModule('viewMenu')">‚¨Ö BACK</button>
        <h2 id="displayDeviceName">DEVICES CHECK LIST</h2>
        <div class="flex-layout">
            <div class="column">
                <div class="group"><label class="main-label">Operator:</label><select id="selectOp" disabled style="background: #eee;"><option value="">-- Active User --</option></select></div>
                <div class="group">
                    <label class="main-label">Test Inspection:</label>
                    <div class="stage-container">
                        <button type="button" class="btn-stage" id="btnBefore" onclick="changeStage('BEFORE TEST')">BEFORE</button>
                        <button type="button" class="btn-stage" id="btnAfter" onclick="changeStage('AFTER TEST')">AFTER</button>
                    </div>
                </div>
                <div class="group"><label class="main-label">Send Report to:</label><select id="selectMail"><option value="">-- Select E-Mail --</option></select></div>
            </div>
            <div class="column">
                <div class="group"><label class="main-label">Visual Inspection Tasks:</label><div class="tasks-scroll" id="tasksContainer"></div></div>
                <div class="group" style="margin-top:8px;"><label class="main-label">Comments:</label><textarea id="additionalNotes" placeholder="Write here..."></textarea></div>
                <div class="group">
                    <div style="display:flex; justify-content:space-between; align-items:center;"><label class="main-label">Signature</label><button type="button" style="font-size:11px; cursor:pointer;" onclick="pad.clear()">üóë CLEAR</button></div>
                    <div class="signature-box"><canvas id="canvas"></canvas></div>
                </div>
            </div>
        </div>
        <button id="sendBtn" class="btn-send" onclick="enviarReporte()">SUBMIT & SEND REPORT</button>
    </div>

    <div id="viewTooling" class="view-layer">
        <button class="btn-back" onclick="showModule('viewMenu')">‚¨Ö BACK</button>
        <h2>Tooling Project Schedule</h2>
        
        <div class="tooling-input-bar">
            <div><label>Project Name</label><input type="text" id="toolProject" placeholder="Ex: Project A"></div>
            <div><label>Activity</label><input type="text" id="toolTask" placeholder="Activity"></div>
            <div style="flex:0.2;"><label>Days</label><input type="number" id="toolDays" placeholder="0" oninput="revisarConflictoRealTime()"></div>
            <div style="flex:0.4;"><label>Start Date</label><input type="date" id="toolStart" oninput="revisarConflictoRealTime()"></div>
            <div style="flex:0.5;"><label>Device Type</label>
                <select id="deviceType" onchange="updateHIMOptions(); revisarConflictoRealTime();">
                    <option value="">-- Select --</option>
                </select>
            </div>
            <div style="flex:0.6;"><label>HIM</label>
                <select id="toolHIM" onchange="revisarConflictoRealTime()">
                    <option value="">Select Device First</option>
                </select>
            </div>
            <div style="flex:0.4;"><label>Scale</label>
                <select id="viewScale" onchange="renderGantt()">
                    <option value="day">By Day</option>
                    <option value="week">By Week</option>
                    <option value="month">By Month</option>
                    <option value="year">By Year</option>
                </select>
            </div>
            <button onclick="addToolingRow()" style="background: var(--huf-red); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; height: 38px;">ADD HIM</button>
        </div>

        <div class="collapse-controls">
            <button class="btn-collapse" onclick="toggleAllProjects(true)">‚ûï EXPAND ALL</button>
            <button class="btn-collapse" onclick="toggleAllProjects(false)">‚ûñ COLLAPSE ALL</button>
            <button class="btn-center" onclick="centerToday()">üéØ CENTER TODAY</button>
            <button class="btn-stats" onclick="showModule('viewStats')">üìä STATS</button>
        </div>

        <div class="gantt-wrapper" id="ganttScrollParent">
            <div id="ganttContainer"></div>
        </div>
    </div>

    <div id="viewStats" class="view-layer">
        <button class="btn-back" onclick="showModule('viewTooling')">‚¨Ö BACK</button>
        <h2>Usage Stats by Device Type (2026)</h2>
        <div id="statsMainContainer" class="stats-view-container"></div>
    </div>
</div>

<script>
    // CONFIGURACI√ìN FIREBASE (Sustituye la URL por la tuya)
    const firebaseConfig = {
        databaseURL: "https://test-huf-default-rtdb.firebaseio.com/" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let stage = ""; let pad; let userSession = ""; 
    let toolingProjects = []; 

    // --- SINCRONIZACI√ìN EN TIEMPO REAL ---
    db.ref('toolingProjects').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // Convertir fechas string a objetos Date para el sistema
            toolingProjects = data.map(proj => ({
                ...proj,
                activities: (proj.activities || []).map(act => ({
                    ...act,
                    teams: (act.teams || []).map(t => ({
                        ...t,
                        start: new Date(t.start)
                    }))
                }))
            }));
            renderGantt(); 
        } else {
            toolingProjects = [];
            renderGantt();
        }
    });

    function guardarCambios() {
        // Convertir fechas a string ISO para guardar en JSON (Firebase no admite objetos Date)
        const dataParaGuardar = toolingProjects.map(proj => ({
            ...proj,
            activities: proj.activities.map(act => ({
                ...act,
                teams: act.teams.map(t => ({
                    ...t,
                    start: t.start.toISOString()
                }))
            }))
        }));
        db.ref('toolingProjects').set(dataParaGuardar);
    }

    function popularDeviceTypes() {
        const devSelect = document.getElementById('deviceType');
        if (!devSelect || !window.huf_devices_config) return;
        devSelect.innerHTML = '<option value="">-- Select --</option>';
        window.huf_devices_config.forEach(dev => {
            devSelect.add(new Option(dev.name, dev.id));
        });
    }

    function updateHIMOptions() {
        const typeId = document.getElementById('deviceType').value;
        const himSelect = document.getElementById('toolHIM');
        himSelect.innerHTML = "";
        if(!typeId) {
            himSelect.add(new Option("Select Device First", ""));
            return;
        }
        const deviceData = window.huf_devices_config.find(d => d.id === typeId);
        if (deviceData && deviceData.hims) {
            deviceData.hims.forEach(h => himSelect.add(new Option(h, h)));
        }
    }

    function showModule(viewId) {
        const card = document.getElementById('mainCard');
        document.querySelectorAll('.view-layer').forEach(v => v.classList.remove('active-view'));
        document.getElementById(viewId).classList.add('active-view');
        (viewId === 'viewTooling' || viewId === 'viewStats') ? card.classList.add('wide-view') : card.classList.remove('wide-view');
        if(viewId === 'viewChecklist') ajustarCanvas();
        if(viewId === 'viewTooling') renderGantt();
        if(viewId === 'viewStats') renderAllStats();
    }

    function validarAcceso() {
        const u = document.getElementById('userInput').value;
        const p = document.getElementById('passInput').value;
        const user = (window.usuarios_password || []).find(item => item.user === u && item.pass === p);
        if (user) {
            userSession = user.nombre;
            document.getElementById('selectOp').innerHTML = `<option>${userSession}</option>`;
            cargarInfo(); 
            popularDeviceTypes();
            showModule('viewMenu');
        } else { document.getElementById('loginError').style.display = 'block'; }
    }

    function logout() { userSession = ""; showModule('viewLogin'); }
    
    function manejarEnter(event) { 
        const current = document.querySelector('.active-view').id;
        if (event.key === "Enter" && current === 'viewLogin') validarAcceso();
        if (current === 'viewTooling') {
            const wrapper = document.getElementById('ganttScrollParent');
            const step = 60; 
            if (event.key === "ArrowRight") { wrapper.scrollLeft += step; event.preventDefault(); }
            else if (event.key === "ArrowLeft") { wrapper.scrollLeft -= step; event.preventDefault(); }
        }
    }

    function limpiarError() { document.getElementById('loginError').style.display = 'none'; }

    function cargarInfo() {
        const tareas = window.lista_tareas || []; const correos = window.lista_correos || [];
        document.getElementById('displayDeviceName').innerText = (window.nombre_dispositivo || "DEVICE") + " CHECK LIST";
        const mailSelect = document.getElementById('selectMail');
        if (mailSelect.options.length <= 1) {
            correos.forEach(m => mailSelect.add(new Option(m, m)));
            const tContainer = document.getElementById('tasksContainer');
            tContainer.innerHTML = "";
            tareas.forEach(t => {
                const row = document.createElement('label'); row.className = 'task-row';
                row.innerHTML = `<input type="checkbox" onchange="this.parentElement.classList.toggle('checked-task', this.checked)"><span>${t}</span>`;
                tContainer.appendChild(row);
            });
        }
    }

    window.onload = () => { 
        const canvas = document.getElementById('canvas');
        if(canvas) pad = new SignaturePad(canvas); 
        ajustarCanvas(); 
    };
    
    function changeStage(s) { stage = s; document.getElementById('btnBefore').className = s==='BEFORE TEST'?'btn-stage active':'btn-stage'; document.getElementById('btnAfter').className = s==='AFTER TEST'?'btn-stage active':'btn-stage'; }
    function ajustarCanvas() { const canvas = document.getElementById('canvas'); if(!canvas) return; const ratio = Math.max(window.devicePixelRatio || 1, 1); canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio; canvas.getContext("2d").scale(ratio, ratio); }

    function enviarReporte() {
        const mail = document.getElementById('selectMail').value;
        if(!userSession || !mail || !stage || pad.isEmpty()) return alert("Missing info");
        emailjs.init("mJeuEhSJ1S_wZAzDy");
        emailjs.send("service_fono7vd", "template_egho97s", {
            device_name: window.nombre_dispositivo, operator_name: userSession,
            date_report: new Date().toLocaleString(), stage_report: stage, email_to: mail,
            signature_image: document.getElementById('canvas').toDataURL()
        }).then(() => { alert("SENT!"); location.reload(); });
    }

    function validarDisponibilidad(him, startNew, daysNew) {
        if(!him || !startNew || !daysNew || isNaN(daysNew)) return { conflict: false };
        const endNew = new Date(startNew);
        endNew.setDate(endNew.getDate() + daysNew);
        for (let proj of toolingProjects) {
            for (let act of proj.activities) {
                for (let t of act.teams) {
                    if (t.name === him) {
                        const startExist = new Date(t.start);
                        const endExist = new Date(t.start);
                        endExist.setDate(endExist.getDate() + t.days);
                        if (startNew < endExist && endNew > startExist) return { conflict: true, project: proj.name, activity: act.name };
                    }
                }
            }
        }
        return { conflict: false };
    }

    function revisarConflictoRealTime() {
        const him = document.getElementById('toolHIM').value;
        const days = parseInt(document.getElementById('toolDays').value);
        const startStr = document.getElementById('toolStart').value;
        const devSelect = document.getElementById('deviceType');
        const himSelect = document.getElementById('toolHIM');
        if (!him || !days || !startStr || !devSelect.value) { devSelect.style.background = "#fff"; himSelect.style.background = "#fff"; return; }
        const startDate = new Date(startStr + "T00:00:00");
        const check = validarDisponibilidad(him, startDate, days);
        if (check.conflict) { devSelect.style.background = "#ffcccc"; himSelect.style.background = "#ffcccc"; devSelect.style.borderColor = "red"; himSelect.style.borderColor = "red"; }
        else { devSelect.style.background = "#fff"; himSelect.style.background = "#fff"; devSelect.style.borderColor = "#ccc"; himSelect.style.borderColor = "#ccc"; }
    }

    function addToolingRow() {
        const projName = document.getElementById('toolProject').value.trim() || "Unnamed Project";
        const taskName = document.getElementById('toolTask').value.trim();
        const days = parseInt(document.getElementById('toolDays').value);
        const startStr = document.getElementById('toolStart').value;
        const him = document.getElementById('toolHIM').value;
        const devTypeId = document.getElementById('deviceType').value;
        if (!taskName || !days || !startStr || !him || !devTypeId) return alert("Fill all details");
        const startDate = new Date(startStr + "T00:00:00");
        const check = validarDisponibilidad(him, startDate, days);
        if (check.conflict) return alert(`CONFLICT: ${him} is busy.\nProject: ${check.project}\nActivity: ${check.activity}`);
        
        let project = toolingProjects.find(p => p.name.toLowerCase() === projName.toLowerCase());
        if (!project) { project = { name: projName, activities: [], collapsed: false }; toolingProjects.push(project); }
        let activity = project.activities.find(a => a.name.toLowerCase() === taskName.toLowerCase());
        if (!activity) { activity = { name: taskName, teams: [] }; project.activities.push(activity); }
        activity.teams.push({ name: him, start: startDate, days: days, typeId: devTypeId });
        
        guardarCambios(); 
    }

    function toggleAllProjects(expand) { toolingProjects.forEach(p => p.collapsed = !expand); guardarCambios(); }
    function toggleProject(pIdx) { toolingProjects[pIdx].collapsed = !toolingProjects[pIdx].collapsed; guardarCambios(); }

    function centerToday() {
        const wrapper = document.getElementById('ganttScrollParent');
        const todayCell = document.querySelector('.gantt-day-cell.is-today');
        if (wrapper && todayCell) wrapper.scrollLeft = todayCell.offsetLeft - (wrapper.offsetWidth / 2) + (todayCell.offsetWidth / 2);
    }

    function sortTooling() {
        toolingProjects.forEach(proj => {
            proj.activities.forEach(act => act.teams.sort((a, b) => a.start - b.start));
            proj.activities.sort((a, b) => Math.min(...a.teams.map(t => t.start)) - Math.min(...b.teams.map(t => t.start)));
        });
        toolingProjects.sort((a, b) => {
            const getMin = p => Math.min(...p.activities.flatMap(ac => ac.teams.map(te => te.start.getTime())));
            return getMin(a) - getMin(b);
        });
    }

    function getPastelColor(typeId) { 
        const idNum = parseInt(typeId) || 0;
        const hue = (idNum * 137.5) % 360; 
        return `hsl(${hue}, 75%, 85%)`;
    }

    function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(),0,1))) / 86400000) + 1)/7); }

    function renderGantt() {
        const container = document.getElementById('ganttContainer');
        const scale = document.getElementById('viewScale').value;
        const today = new Date(); today.setHours(0,0,0,0);
        if (toolingProjects.length === 0) { container.innerHTML = `<p style="text-align:center; padding:20px;">No projects added.</p>`; return; }
        sortTooling();
        let allDates = []; let endDates = [];
        toolingProjects.forEach(p => p.activities.forEach(a => a.teams.forEach(t => {
            allDates.push(new Date(t.start));
            let endD = new Date(t.start); endD.setDate(endD.getDate() + t.days); endDates.push(endD);
        })));
        let minDate = new Date(Math.min(...allDates, today.getTime())); minDate.setDate(minDate.getDate() - 15);
        let maxDate = new Date(Math.max(...endDates, today.getTime())); maxDate.setDate(maxDate.getDate() + 45);
        let htmlLabels = [];
        if (scale === 'day') {
            let cols = Math.ceil((maxDate - minDate) / 86400000);
            for(let i=0; i<cols; i++) {
                let d = new Date(minDate); d.setDate(d.getDate() + i);
                htmlLabels.push({ label: d.getDate()+"/"+(d.getMonth()+1), isToday: d.getTime() === today.getTime() });
            }
        } else if (scale === 'week') {
            let cols = Math.ceil((maxDate - minDate) / (86400000*7)) + 1;
            for(let i=0; i<cols; i++) {
                let d = new Date(minDate); d.setDate(d.getDate() + (i*7));
                htmlLabels.push({ label: "W"+getWeekNumber(d), isToday: today >= d && today < new Date(d.getTime()+(86400000*7)) });
            }
        } else if (scale === 'month') {
            let cols = (maxDate.getFullYear() - minDate.getFullYear()) * 12 + (maxDate.getMonth() - minDate.getMonth()) + 2;
            for(let i=0; i<cols; i++) {
                let d = new Date(minDate.getFullYear(), minDate.getMonth() + i, 1);
                htmlLabels.push({ label: d.toLocaleString('en', {month:'short'})+" "+d.getFullYear().toString().substr(-2), isToday: today.getMonth() === d.getMonth() && today.getFullYear() === d.getFullYear() });
            }
        } else {
            let cols = (maxDate.getFullYear() - minDate.getFullYear()) + 2;
            for(let i=0; i<cols; i++) {
                let d = new Date(minDate.getFullYear() + i, 0, 1);
                htmlLabels.push({ label: d.getFullYear().toString(), isToday: today.getFullYear() === d.getFullYear() });
            }
        }
        let columns = htmlLabels.length;
        let html = `<div class="gantt-grid"><div class="gantt-header-title">PROJECT / ACTIVITY</div><div class="gantt-header-days">`;
        htmlLabels.forEach(obj => html += `<div class="gantt-day-cell ${obj.isToday?'is-today':''}"><div class="vertical-text">${obj.label}</div></div>`);
        html += `</div>`;
        toolingProjects.forEach((proj, pIdx) => {
            html += `<div class="gantt-row"><div class="gantt-task-name" style="background:#444 !important; color:white;" onclick="toggleProject(${pIdx})"><span>${proj.collapsed?'‚ûï':'‚ûñ'} üìÅ ${proj.name}</span></div><div class="gantt-bar-container" style="background:#555;"></div></div>`;
            if (!proj.collapsed) {
                proj.activities.forEach((act, aIdx) => {
                    html += `<div class="gantt-row"><div class="gantt-task-name" style="padding-left:25px;"><span>üîπ ${act.name}</span></div><div class="gantt-bar-container">`;
                    act.teams.forEach((t, tIdx) => {
                        let leftPos = 0, widthSize = 0;
                        if(scale==='day'||scale==='week'){ 
                            let div = scale==='day'?1:7; leftPos=(((t.start-minDate)/86400000)/div)*(100/columns); widthSize=(t.days/div)*(100/columns);
                        } else if(scale==='month'){
                            let off = (t.start.getFullYear()-minDate.getFullYear())*12+(t.start.getMonth()-minDate.getMonth()); leftPos=(off+(t.start.getDate()/30))*(100/columns); widthSize=(t.days/30)*(100/columns);
                        } else {
                            let off = t.start.getFullYear()-minDate.getFullYear(); leftPos=(off+(getWeekNumber(t.start)/52))*(100/columns); widthSize=(t.days/365)*(100/columns);
                        }
                        let h = 100/act.teams.length;
                        html += `<div class="gantt-bar" style="left:${leftPos}%; width:${widthSize}%; height:${h-4}%; top:${h*tIdx}%; background:${getPastelColor(t.typeId)};"><span>${t.name}</span></div>`;
                    });
                    html += `</div></div>`;
                });
            }
        });
        container.innerHTML = html + "</div>";
        setTimeout(centerToday, 100);
    }

    function renderAllStats() {
        const container = document.getElementById('statsMainContainer');
        const year = 2026; container.innerHTML = "";
        if (!window.huf_devices_config) return;

        window.huf_devices_config.forEach(dev => {
            let weekData = new Array(52).fill(0);
            const totalHimsInType = dev.hims.length || 1;

            toolingProjects.forEach(proj => {
                proj.activities.forEach(act => {
                    act.teams.forEach(t => {
                        if (t.typeId === dev.id) {
                            let current = new Date(t.start);
                            for (let i = 0; i < t.days; i++) {
                                if (current.getFullYear() === year) {
                                    let wn = getWeekNumber(current) - 1;
                                    if (wn >= 0 && wn < 52) weekData[wn] += ((1 / 7) * 100) / totalHimsInType;
                                }
                                current.setDate(current.getDate() + 1);
                            }
                        }
                    });
                });
            });

            const row = document.createElement('div'); row.className = 'device-stat-row';
            let deviceColor = getPastelColor(dev.id);
            let rowHtml = `<div class="device-stat-title">${dev.name} Usage (%)</div><div class="stats-week-wrapper">`;
            weekData.forEach((pct, w) => {
                const safePct = Math.min(pct, 100);
                const d = new Date(year, 0, 1 + (w * 7));
                const monthName = d.toLocaleString('en', {month:'short'});
                rowHtml += `<div class="stats-week-col"><div class="bar-fill" style="height:${safePct}%; background:${deviceColor}" data-label="W${w+1} (${monthName}): ${safePct.toFixed(1)}%"></div><div class="week-label-stat">${(w+1)%4===0?w+1:''}</div></div>`;
            });
            rowHtml += `</div>`; row.innerHTML = rowHtml; container.appendChild(row);
        });
    }
</script>
</body>
</html>

